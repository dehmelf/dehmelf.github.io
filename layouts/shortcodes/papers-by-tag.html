{{ $papers := where .Site.RegularPages "Section" "papers-read" }}
{{ $papers = where $papers "Params.draft" "!=" true }}

<!-- Define topic hierarchy -->
{{ $topicHierarchy := dict 
  "Quantum Computing" (slice "Quantum Error Correction" "Quantum Algorithms" "Quantum Supremacy" "NISQ" "Quantum Hardware" "Quantum Cryptography")
  "Machine Learning" (slice "Deep Learning" "Transformers" "Reinforcement Learning" "Neural Architecture" "Computer Vision" "NLP")
  "Cryptography" (slice "Post-Quantum Cryptography" "Zero-Knowledge Proofs" "Lattice-Based" "Homomorphic Encryption" "Secure Computation")
  "Complexity Theory" (slice "P vs NP" "Circuit Complexity" "Communication Complexity" "Hardness Results" "Lower Bounds")
  "Systems" (slice "Distributed Systems" "Operating Systems" "Compilers" "Architecture" "Networks")
  "Algorithms" (slice "Graph Algorithms" "Optimization" "Randomized Algorithms" "Approximation Algorithms" "Data Structures")
}}

<!-- Collect papers by topic -->
{{ $papersByTopic := dict }}
{{ range $papers }}
  {{ $paper := . }}
  {{ range .Params.tags }}
    {{ $tag := . }}
    {{ range $mainTopic, $subtopics := $topicHierarchy }}
      {{ if or (eq $tag $mainTopic) (in $subtopics $tag) }}
        {{ $existing := index $papersByTopic $mainTopic | default slice }}
        {{ $papersByTopic = merge $papersByTopic (dict $mainTopic ($existing | append $paper)) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="topic-container">
  <div class="main-topics">
    {{ range $topic, $subtopics := $topicHierarchy }}
      {{ $paperCount := len (index $papersByTopic $topic | default slice) }}
      {{ if gt $paperCount 0 }}
      <div class="topic-group-box">
        <button class="main-topic-btn" data-topic="{{ $topic | urlize }}">
          <span>{{ $topic }}</span>
          <span class="topic-meta">
            <span class="paper-count">({{ $paperCount }})</span>
            <span class="expand-icon">â–¼</span>
          </span>
        </button>
        <div class="subtopics">
          {{ range $subtopics }}
            {{ $subtopic := . }}
            {{ $subCount := 0 }}
            {{ range $papers }}
              {{ if in .Params.tags $subtopic }}
                {{ $subCount = add $subCount 1 }}
              {{ end }}
            {{ end }}
            {{ if gt $subCount 0 }}
            <button class="subtopic-btn" data-tag="{{ $subtopic | urlize }}">
              {{ $subtopic }} <span class="subtopic-count">({{ $subCount }})</span>
            </button>
            {{ end }}
          {{ end }}
        </div>
      </div>
      {{ end }}
    {{ end }}
    
    <button class="show-all-btn" data-tag="all">
      Show All Papers
    </button>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const mainTopicBtns = document.querySelectorAll('.main-topic-btn');
  const subtopicBtns = document.querySelectorAll('.subtopic-btn');
  const showAllBtn = document.querySelector('.show-all-btn');
  const papers = document.querySelectorAll('.paper-entry-box');
  
  // Handle main topic expansion
  mainTopicBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const subtopics = this.nextElementSibling;
      const expandIcon = this.querySelector('.expand-icon');
      const topic = this.dataset.topic;
      
      // Toggle subtopics
      if (subtopics.style.display === 'none' || subtopics.style.display === '') {
        subtopics.style.display = 'block';
        subtopics.classList.add('expanded');
        expandIcon.style.transform = 'rotate(180deg)';
        
        // Show papers for this main topic
        filterPapersByMainTopic(topic);
      } else {
        subtopics.style.display = 'none';
        subtopics.classList.remove('expanded');
        expandIcon.style.transform = 'rotate(0deg)';
      }
    });
  });
  
  // Handle subtopic filtering
  subtopicBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const tag = this.dataset.tag;
      filterPapersByTag(tag);
      
      // Highlight selected button
      subtopicBtns.forEach(b => {
        b.classList.remove('active');
      });
      this.classList.add('active');
    });
  });
  
  // Show all papers
  showAllBtn?.addEventListener('click', function() {
    papers.forEach(paper => {
      paper.style.display = 'block';
    });
    
    // Reset all button styles
    subtopicBtns.forEach(b => {
      b.classList.remove('active');
    });
  });
  
  function filterPapersByTag(tag) {
    papers.forEach(paper => {
      const paperTags = paper.dataset.tags ? paper.dataset.tags.split(',') : [];
      if (paperTags.some(t => t.trim() === tag)) {
        paper.style.display = 'block';
      } else {
        paper.style.display = 'none';
      }
    });
  }
  
  function filterPapersByMainTopic(topic) {
    const topicMap = {
      'quantum-computing': ['quantum-computing', 'quantum-error-correction', 'quantum-algorithms', 'quantum-supremacy', 'nisq', 'quantum-hardware', 'quantum-cryptography'],
      'machine-learning': ['machine-learning', 'deep-learning', 'transformers', 'reinforcement-learning', 'neural-architecture', 'computer-vision', 'nlp'],
      'cryptography': ['cryptography', 'post-quantum-cryptography', 'zero-knowledge-proofs', 'lattice-based', 'homomorphic-encryption', 'secure-computation'],
      'complexity-theory': ['complexity-theory', 'p-vs-np', 'circuit-complexity', 'communication-complexity', 'hardness-results', 'lower-bounds'],
      'systems': ['distributed-systems', 'operating-systems', 'compilers', 'architecture', 'networks'],
      'algorithms': ['graph-algorithms', 'optimization', 'randomized-algorithms', 'approximation-algorithms', 'data-structures']
    };
    
    const relatedTags = topicMap[topic] || [];
    
    papers.forEach(paper => {
      const paperTags = paper.dataset.tags ? paper.dataset.tags.split(',').map(t => t.trim()) : [];
      if (paperTags.some(tag => relatedTags.includes(tag))) {
        paper.style.display = 'block';
      } else {
        paper.style.display = 'none';
      }
    });
  }
});
</script>
